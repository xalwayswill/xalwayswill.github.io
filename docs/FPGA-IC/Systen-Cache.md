# 关于CPU Cache<sup>[1](https://blog.csdn.net/zhangj95/article/details/81199272#fn1)</sup>

通常情况下，CPU从内存中直接读取数据需要几百个时钟周期，在这几百个时钟周期内，CPU除了等待什么也不能做。而引入Cache高速缓存后，当CPU需要从内存中获取数据时，Cache可以提前把CPU所需要指令和数据从内存中预取到cache缓存中，CPU直接从cache中取指令和数据。

Cache的基本原理是局部性原理，局部性原理简单说起来就是在前一段时间经常用到的代码，在将来会被再次使用的几率也很高。
Cache对CPU的意义是类似的，主存就是那个带有瓶颈的水桶，如果CPU始终要等待对内存的操作完成然后再进行下一个环节，那么在所有跟内存操作相关的指令执行时，CPU就自动降为接近内存的速度。也许你会认为很多指令是寄存器指令，内存读写在整个程序中所占的比例并不大，但是请不要忘记很恐怖的一点是，所有的指令都在内存中，也就是说每执行一条指令都要去读内存。有了这个前提，我们可以想象，在程序执行的时候，CPU会随时随刻地从内存中读取代码，整条总线会被CPU占住，这样的话总线上的其他Master（比如说[DMA](https://so.csdn.net/so/search?q=DMA&spm=1001.2101.3001.7020)控制器，I2C-Slave等）就将全部受到影响，由此可见没有Cache的结果就将是灾难性的。有些Cache还会跟读写FIFO紧密配合，不过目的都是一致的，解决内存瓶颈问题。有人可能会有疑问，多数ARM7内核的芯片是没有Cache的，为什么依然能够运行得很快，这是因为IC designer在设计总线结构时动了手脚，将CPU取指的总线同其他部分总线隔离，以避免CPU对其他总线设备的干扰。

CPU Cache大多是SRAM(静态RAM)，而内存大多是DRAM(动态随机存储)或者DDR(双倍动态随机存储)，Cache由三级组成，一级(L1)最快，但是容量最小；三级(LLC，Last Level Cache)最慢，但是容量最大。

在多核CPU中每个核拥有独立的L1和L2两级cache，由于程序指令和程序数据的行为和热点分布差异很大，因此L1 Cache也被划分成L1i (i for instruction)和L1d (d for data)两种专门用途的缓存。为了保证所有的核看到正确的内存数据，一个核在写入L1 cache后，CPU会执行Cache一致性算法把对应的Cache Line（Cache Line是Cache与内存数据交换的最小单位）同步到其他核，这个过程并不很快，是微秒级的，相比之下写入L1 cache只需要若干纳秒。当很多线程在频繁修改某个字段时，这个字段所在的Cache Line被不停地同步到不同的核上，就像在核间弹来弹去，这个现象就叫做Cache Bouncing。

三级 Cache 由所有的核所共有，由于共享的存在，有的处理器可能会极大地占用三级Cache，导致其他处理器只能占用极小的容量，从而导致Cache不命中，性能下降。Cache-misses情况下读取一次内存大约为150个时钟周期，而Cache-hit情况下L3 cache命中读取一次内存需要40个时钟周期。


# Cache写机制：Write-through与Write-back<sup>[3](https://blog.csdn.net/zhangj95/article/details/81199272#fn3)</sup>

当CPU采用高速缓存时，对于Write-hit而言，它的写内存操作有两种模式：

1.  Write-through（直写模式）：在数据更新时，同时写入缓存Cache和后端存储。此模式的优点是操作简单；缺点是因为数据修改需要同时写入内存，总线工作繁忙，内存的带宽被大大占用，因此运行速度会受到影响数据。假设一段程序在频繁地修改一个局部变量，局部变量生存周期很短，而且其他进程/线程也用不到它，CPU依然会频繁地在Cache和内存之间交换数据，造成不必要的带宽损失。

2.  Write-back（回写模式）：在数据更新时只写入缓存Cache，而不是立即写入内存。只在数据被替换出缓存时，被修改的缓存数据才会被写到后端存储。此模式的优点是数据写入速度快，因为不需要写存储；缺点是一旦更新后的数据未被写入存储时出现系统掉电的情况，数据将无法找回。对一cache行的多次写命中都在cache中快速完成修改，只是需被替换时才写回速度较慢的主存，减少了访问主的次数从而提高了效率。为支持这种策略，每个cache行必须配置一个修改位，以反映此行是否被CPU修改过。

https://blog.csdn.net/zhangj95/article/details/81199272
